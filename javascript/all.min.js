function initImage(e){var t=new Image;t.src=e;var a=document.getElementById("canvas"),i=a.getContext("2d");a.width=1024,a.height=a.width*(t.height/t.width),i.drawImage(t,0,0,a.width,a.height);var r=a.toDataURL("image/png");$("#source").attr("value",r),$("#loadimage").attr("src",r)}function createImage(e,t,a){var i=new Image;i.src="images/object/"+e+".png";var r=new Image;r.src=t;var n=document.getElementById("result");n.width=$coverimage.width()*a,n.height=$coverimage.height()*a;var g=n.getContext("2d");g.rect(0,0,$coverimage.width()*a,$coverimage.height()*a),g.fillStyle="#CCCCCC",g.fill(),g.drawImage(r,$dragger.position().left*a,$dragger.position().top*a,$dragger.width()*a,$dragger.height()*a),g.drawImage(i,0,0,$coverimage.width()*a,$coverimage.height()*a);var o=n.toDataURL("image/png"),s=window.navigator.userAgent,d=s.indexOf("MSIE ");if(d>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var c="<p>請按右鍵另存圖片</p>";c+="<img src='"+o+"' alt='10'/>";var u=window.open();u.document.write(c)}else $("#download").attr("href",o),$("#download").attr("download",+new Date+".png"),$("#download")[0].click(),ga("send","event","download","pic",+new Date)}function getOrientation(e,t){var a=new FileReader;a.onload=function(e){var a=new DataView(e.target.result);if(65496!=a.getUint16(0,!1))return t(-2);for(var i=a.byteLength,r=2;i>r;){var n=a.getUint16(r,!1);if(r+=2,65505==n){if(1165519206!=a.getUint32(r+=2,!1))return t(-1);var g=18761==a.getUint16(r+=6,!1);r+=a.getUint32(r+4,g);var o=a.getUint16(r,g);r+=2;for(var s=0;o>s;s++)if(274==a.getUint16(r+12*s,g))return t(a.getUint16(r+12*s+8,g))}else{if(65280!=(65280&n))break;r+=a.getUint16(r,!1)}}return t(-1)},a.readAsArrayBuffer(e)}function handleFileSelect(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;loadImage(t)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function loadImage(e){function t(){g=new Image,g.onload=i,g.src=n.result}function a(e,t,a){var i=a*Math.PI/180,r=Math.cos(i),n=Math.sin(i);return 0>n&&(n=-n),0>r&&(r=-r),[t*n+e*r,t*r+e*n]}function i(){getOrientation(r,function(e){console.log("orientation: "+e);var t=document.getElementById("canvas"),i=t.getContext("2d"),r=1024,n=r*(g.height/g.width),o=0;6==e?(console.log("rotate 90degree"),o=90):3==e?(console.log("rotate 180degree"),o=180):8==e&&(console.log("rotate 180degree"),o=270);var s=a(t.width,t.height,o);t.width=s[0],t.height=s[1],i.clearRect(0,0,t.width,t.height),i.save(),i.translate(t.width/2,t.height/2),i.rotate(o*Math.PI/180),i.drawImage(g,-r/2,-n/2,r,n),i.restore();var d=t.toDataURL("image/png");$("#source").attr("value",d),$userimage.css("background-image","url("+d+")"),$("<img/>").attr("src",d).load(function(){var e=$("input[name=template]:checked").val(),t=[$userimage.width(),$userimage.height()];userimage_size=[this.width,this.height],resizeDragger(userimage_size,t,e),$loading.hide(),$uploading.fadeOut()})})}var r,n,g;e?($uploading.fadeIn(),$loading.show(),r=e[0],n=new FileReader,n.onload=t,n.readAsDataURL(r)):alert("悲劇！您的瀏覽器不支援檔案上傳！")}function getImgSize(e){var t=new Image;return t.src=e,[t.width,t.height]}function getBackgroundImage(e){var t=e.css("background-image");return t.replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}function getScaledImageSize(e,t){var a,i,r;return e[0]>=e[1]?(a=t[1]/e[1],i=e[0]*a,r=e[1]*a):1*e[0]/e[1]<1*t[0]/t[1]?(a=t[1]/e[1],r=e[1]*a,i=e[0]*a):(a=t[0]/e[0],i=e[0]*a,r=e[1]*a),[i,r]}function resizeDragger(e,t,a,i){a="undefined"!=typeof a?a:1,i="undefined"!=typeof i?i:0;var r,n,g,o,s=t[0];r=getScaledImageSize(e,t)[0],n=getScaledImageSize(e,t)[1],e[0]>=e[1]?(g=0,o=.5*(r-s)*-1):(g=-1*(n-t[1]),o=0),6==a?(o=.2*s*-1,e[0]>e[1]&&(o-=.5*(r-s))):9==a?($sizer.slider("value",65),e[0]>e[1]?(o=.65*s*.13*.5,r*=.65,n*=.65,g=.48*(s-n)):(o=.65*s*.13*.5,r*=.65,n*=.65,g=.48*(s-n))):10==a&&($sizer.slider("value",92),e[0]>e[1]?(r=.92*s,n=r*(e[1]/e[0]),g=.045*s,o=.5*(s-r)):(r=.92*r,n=.92*n,g=.045*s,o=.5*(s-r))),$dragger.css("width",r+"px").css("height",n+"px").css("top",g+"px").css("left",o+"px"),$userimage.css("background-size",r+"px "+n+"px").css("background-position",o+"px "+g+"px")}function getBackgroundSize(e){return size=e.split(" "),[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(e){return position=e.split(" "),[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(e,t){return[.5*e[0]+t[0],.5*e[1]+t[1]]}function px2int(e){return parseFloat(e.replace("px",""))}var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading"),$(window).load(function(){var e=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,e);var t=document.getElementById("template1");t.checked=!0,initImage("images/wuo_sample.png")}),$(document).ready(function(){$("body").iealert({support:"ie9",title:"您的瀏覽器太舊啦！",text:"請更新您的瀏覽器，我們推薦您使用 Google Chrome",closeBtn:!1,upgradeTitle:"下載 Google Chrome",upgradeLink:"http://www.google.com/chrome/"}),$dragger.draggable({drag:function(e){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top")),0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");var t=$("input[name=template]:checked").val();(9==t||10==t)&&$userimage.attr("class","inner")}}),$sizer.slider({value:100,max:180,min:30,slide:function(e,t){var a=getBackgroundSize($userimage.css("background-size")),i=getBackgroundPosition($userimage.css("background-position"));getBackgroundCenterPoint(a,i);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var e=$dragger.position(),a=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,a),size=getScaledImageSize(userimage_size,a),width=size[0]*t.value/100,height=size[1]*t.value/100,$dragger.css("width",width+"px").css("height",height+"px").css("top",e.top+"px").css("left",e.left+"px"),$userimage.css("background-size",width+"px "+height+"px").css("background-position",e.left+"px "+e.top+"px")})}}),$("body").delegate("input[name=template]","change",function(){var e=$(this).val(),t="images/object/"+e+".png";$coverimage.css("background-image","url("+t+")"),1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner"),$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){[this.width,this.height],[$userimage.width(),$userimage.height()]})}),$("#normalSubmit").click(function(){var e=($userimage.width(),getBackgroundSize($userimage.css("background-size")),getBackgroundPosition($userimage.css("background-position")),$("input[name=template]:checked").val()),t=$("#source").val();3*$dragger.width(),3*$dragger.height(),3*$dragger.position().left,3*$dragger.position().top;createImage(e,t,3)})}),$(window).konami({code:[55,55,55],cheat:function(){$(".banana").slideDown()}}),$(window).konami({code:[54,54,54],cheat:function(){$("h1,#size-slider").delay(100).animate({opacity:"0"},2900),$("#formbuttons,.template-label").delay(400).animate({opacity:"0"},2600),$("#settings").delay(1e3).animate({opacity:"0"},2e3),$(".left-bottom-corner").delay(800).animate({opacity:"0"},2200),$(".preview").animate({top:"-500px",opacity:"0.5"},3e3).animate({width:"0",opacity:"0"},3e3,function(){$("#content").slideUp()})}}),$(function(){var e=document.getElementById("drop");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),$(".uploadBtn").click(function(){$("#uploadInput").click()}),$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput"),loadImage(input.files),container_size=[$userimage.width(),$userimage.height()],userimage_size=getImgSize(getBackgroundImage($userimage))})});
function createImage(e,a,i){var t=new Image;t.src="images/object/"+e+".png";var r=new Image;r.src=a;var g=document.getElementById("result");g.width=$coverimage.width()*i,g.height=$coverimage.height()*i;var n=g.getContext("2d");n.rect(0,0,$coverimage.width()*i,$coverimage.height()*i),n.fillStyle="#CCCCCC",n.fill(),n.drawImage(r,$dragger.position().left*i,$dragger.position().top*i,$dragger.width()*i,$dragger.height()*i),n.drawImage(t,0,0,$coverimage.width()*i,$coverimage.height()*i);var o=g.toDataURL("image/png"),s=window.navigator.userAgent,d=s.indexOf("MSIE ");if(d>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var c="<p>請按右鍵另存圖片</p>";c+="<img src='"+o+"' alt='10'/>";var u=window.open();u.document.write(c)}else $("#download").attr("href",o),$("#download").attr("download",+new Date+".png"),$("#download")[0].click(),ga("send","event","download","pic",+new Date)}function handleFileSelect(e){e.stopPropagation(),e.preventDefault();var a=e.dataTransfer.files;loadImage(a)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function loadImage(e){function a(){g=new Image,g.onload=i,g.src=r.result}function i(){var e=document.getElementById("canvas");e.width=g.width,e.height=g.height;var a=e.getContext("2d");a.drawImage(g,0,0);var i=e.toDataURL("image/png");$("#source").attr("value",i),$userimage.css("background-image","url("+i+")");var t,r,n=document.getElementById("thumb");g.width>g.height?(r=100,t=100*(g.width/g.height)):(t=100,r=100*(g.height/g.width)),n.width=t,n.height=r;var a=n.getContext("2d");a.drawImage(g,0,0,t,r);var o=n.toDataURL("image/png");$("#templates label").css("background-image","url("+o+")"),$("<img/>").attr("src",i).load(function(){var e=$("input[name=template]:checked").val(),a=[$userimage.width(),$userimage.height()];userimage_size=[this.width,this.height],resizeDragger(userimage_size,a,e),$loading.hide(),$uploading.fadeOut()})}var t,r,g;e?($uploading.fadeIn(),$loading.show(),t=e[0],r=new FileReader,r.onload=a,r.readAsDataURL(t)):alert("悲劇！您的瀏覽器不支援檔案上傳！")}function getImgSize(e){var a=new Image;return a.src=e,[a.width,a.height]}function getBackgroundImage(e){var a=e.css("background-image");return a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}function getScaledImageSize(e,a){var i,t,r;return e[0]>=e[1]?(i=a[1]/e[1],t=e[0]*i,r=e[1]*i):(i=a[0]/e[0],t=e[0]*i,r=e[1]*i),[t,r]}function resizeDragger(e,a,i,t){i="undefined"!=typeof i?i:1,t="undefined"!=typeof t?t:0;var r,g,n,o,s=a[0];r=getScaledImageSize(e,a)[0],g=getScaledImageSize(e,a)[1],e[0]>=e[1]?(n=0,o=.5*(r-s)*-1):(n=-1*(g-a[1]),o=0),6==i?(o=.2*s*-1,e[0]>e[1]&&(o-=.5*(r-s))):9==i?($sizer.slider("value",65),e[0]>e[1]?(o=.65*s*.13*.5,r*=.65,g*=.65,n=.48*(s-g)):(o=.65*s*.13*.5,r*=.65,g*=.65,n=.48*(s-g))):10==i&&($sizer.slider("value",92),e[0]>e[1]?(r=.92*s,g=r*(e[1]/e[0]),n=.045*s,o=.5*(s-r)):(r=.92*r,g=.92*g,n=.045*s,o=.5*(s-r))),$dragger.css("width",r+"px").css("height",g+"px").css("top",n+"px").css("left",o+"px"),$userimage.css("background-size",r+"px "+g+"px").css("background-position",o+"px "+n+"px")}function getBackgroundSize(e){return size=e.split(" "),[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(e){return position=e.split(" "),[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(e,a){return[.5*e[0]+a[0],.5*e[1]+a[1]]}function px2int(e){return parseFloat(e.replace("px",""))}var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading"),$(window).load(function(){var e=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,e);var a=document.getElementById("template1");a.checked=!0}),$(document).ready(function(){$("body").iealert({support:"ie9",title:"您的瀏覽器太舊啦！",text:"請更新您的瀏覽器，我們推薦您使用 Google Chrome",closeBtn:!1,upgradeTitle:"下載 Google Chrome",upgradeLink:"http://www.google.com/chrome/"}),$dragger.draggable({drag:function(e){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top")),0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");var a=$("input[name=template]:checked").val();(9==a||10==a)&&$userimage.attr("class","inner")}}),$sizer.slider({value:100,max:180,min:30,slide:function(e,a){var i=getBackgroundSize($userimage.css("background-size")),t=getBackgroundPosition($userimage.css("background-position"));getBackgroundCenterPoint(i,t);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var e=$dragger.position(),i=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,i),size=getScaledImageSize(userimage_size,i),width=size[0]*a.value/100,height=size[1]*a.value/100,$dragger.css("width",width+"px").css("height",height+"px").css("top",e.top+"px").css("left",e.left+"px"),$userimage.css("background-size",width+"px "+height+"px").css("background-position",e.left+"px "+e.top+"px")})}}),$("body").delegate("input[name=template]","change",function(){var e=$(this).val(),a="images/object/"+e+".png";$coverimage.css("background-image","url("+a+")"),1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner"),$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var a=[this.width,this.height],i=[$userimage.width(),$userimage.height()];resizeDragger(a,i,e)})}),$("#normalSubmit").click(function(){var e=($userimage.width(),getBackgroundSize($userimage.css("background-size")),getBackgroundPosition($userimage.css("background-position")),$("input[name=template]:checked").val()),a=$("#source").val();3*$dragger.width(),3*$dragger.height(),3*$dragger.position().left,3*$dragger.position().top;createImage(e,a,3)})}),$(window).konami({code:[55,55,55],cheat:function(){$(".banana").slideDown()}}),$(window).konami({code:[54,54,54],cheat:function(){$("h1,#size-slider").delay(100).animate({opacity:"0"},2900),$("#formbuttons,.template-label").delay(400).animate({opacity:"0"},2600),$("#settings").delay(1e3).animate({opacity:"0"},2e3),$(".left-bottom-corner").delay(800).animate({opacity:"0"},2200),$(".preview").animate({top:"-500px",opacity:"0.5"},3e3).animate({width:"0",opacity:"0"},3e3,function(){$("#content").slideUp()})}}),$(function(){var e=document.getElementById("drop");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),$(".uploadBtn").click(function(){$("#uploadInput").click()}),$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput"),loadImage(input.files),container_size=[$userimage.width(),$userimage.height()],userimage_size=[this.width,this.height],resizeDragger(userimage_size,container_size,value)})});
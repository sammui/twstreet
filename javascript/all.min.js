function initImage(e){var a=new Image;a.src=e;var t=document.getElementById("canvas"),i=t.getContext("2d");t.width=1024,t.height=t.width*(a.height/a.width),i.drawImage(a,0,0,t.width,t.height);var r=t.toDataURL("image/png");$("#source").attr("value",r),$("#loadimage").attr("src",r)}function createImage(e,a,t){var i=new Image;i.src="images/object/"+e+".png";var r=new Image;r.src=a;var g=document.getElementById("result");g.width=$coverimage.width()*t,g.height=$coverimage.height()*t;var n=g.getContext("2d");n.rect(0,0,$coverimage.width()*t,$coverimage.height()*t),n.fillStyle="#CCCCCC",n.fill(),n.drawImage(r,$dragger.position().left*t,$dragger.position().top*t,$dragger.width()*t,$dragger.height()*t),n.drawImage(i,0,0,$coverimage.width()*t,$coverimage.height()*t);var o=g.toDataURL("image/png"),d=window.navigator.userAgent,s=d.indexOf("MSIE ");if(s>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var c="<p>請按右鍵另存圖片</p>";c+="<img src='"+o+"' alt='10'/>";var u=window.open();u.document.write(c)}else $("#download").attr("href",o),$("#download").attr("download",+new Date+".png"),$("#download")[0].click(),ga("send","event","download","pic",+new Date)}function handleFileSelect(e){e.stopPropagation(),e.preventDefault();var a=e.dataTransfer.files;loadImage(a)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function loadImage(e){function a(){g=new Image,g.onload=t,g.src=r.result}function t(){var e=document.getElementById("canvas"),a=e.getContext("2d");e.width=1024,e.height=e.width*(g.height/g.width),a.drawImage(g,0,0,e.width,e.height);var t=e.toDataURL("image/png");$("#source").attr("value",t),$userimage.css("background-image","url("+t+")");var i,r,n=document.getElementById("thumb");g.width>g.height?(r=100,i=100*(g.width/g.height)):(i=100,r=100*(g.height/g.width)),n.width=i,n.height=r;var a=n.getContext("2d");a.drawImage(g,0,0,i,r);var o=n.toDataURL("image/png");$("#templates label").css("background-image","url("+o+")"),$("<img/>").attr("src",t).load(function(){var e=$("input[name=template]:checked").val(),a=[$userimage.width(),$userimage.height()];userimage_size=[this.width,this.height],resizeDragger(userimage_size,a,e),$loading.hide(),$uploading.fadeOut()})}var i,r,g;e?($uploading.fadeIn(),$loading.show(),i=e[0],r=new FileReader,r.onload=a,r.readAsDataURL(i)):alert("悲劇！您的瀏覽器不支援檔案上傳！")}function getImgSize(e){var a=new Image;return a.src=e,[a.width,a.height]}function getBackgroundImage(e){var a=e.css("background-image");return a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}function getScaledImageSize(e,a){var t,i,r;return e[0]>=e[1]?(t=a[1]/e[1],i=e[0]*t,r=e[1]*t):(t=a[0]/e[0],i=e[0]*t,r=e[1]*t),[i,r]}function resizeDragger(e,a,t,i){t="undefined"!=typeof t?t:1,i="undefined"!=typeof i?i:0;var r,g,n,o,d=a[0];r=getScaledImageSize(e,a)[0],g=getScaledImageSize(e,a)[1],e[0]>=e[1]?(n=0,o=.5*(r-d)*-1):(n=-1*(g-a[1]),o=0),6==t?(o=.2*d*-1,e[0]>e[1]&&(o-=.5*(r-d))):9==t?($sizer.slider("value",65),e[0]>e[1]?(o=.65*d*.13*.5,r*=.65,g*=.65,n=.48*(d-g)):(o=.65*d*.13*.5,r*=.65,g*=.65,n=.48*(d-g))):10==t&&($sizer.slider("value",92),e[0]>e[1]?(r=.92*d,g=r*(e[1]/e[0]),n=.045*d,o=.5*(d-r)):(r=.92*r,g=.92*g,n=.045*d,o=.5*(d-r))),$dragger.css("width",r+"px").css("height",g+"px").css("top",n+"px").css("left",o+"px"),$userimage.css("background-size",r+"px "+g+"px").css("background-position",o+"px "+n+"px")}function getBackgroundSize(e){return size=e.split(" "),[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(e){return position=e.split(" "),[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(e,a){return[.5*e[0]+a[0],.5*e[1]+a[1]]}function px2int(e){return parseFloat(e.replace("px",""))}var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading"),$(window).load(function(){var e=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,e);var a=document.getElementById("template1");a.checked=!0,initImage("images/wuo_sample.png")}),$(document).ready(function(){$("body").iealert({support:"ie9",title:"您的瀏覽器太舊啦！",text:"請更新您的瀏覽器，我們推薦您使用 Google Chrome",closeBtn:!1,upgradeTitle:"下載 Google Chrome",upgradeLink:"http://www.google.com/chrome/"}),$dragger.draggable({drag:function(e){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top")),0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");var a=$("input[name=template]:checked").val();(9==a||10==a)&&$userimage.attr("class","inner")}}),$sizer.slider({value:100,max:180,min:30,slide:function(e,a){var t=getBackgroundSize($userimage.css("background-size")),i=getBackgroundPosition($userimage.css("background-position"));getBackgroundCenterPoint(t,i);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var e=$dragger.position(),t=[$userimage.width(),$userimage.height()];userimage_size=getImgSize(getBackgroundImage($userimage)),resizeDragger(userimage_size,t),size=getScaledImageSize(userimage_size,t),width=size[0]*a.value/100,height=size[1]*a.value/100,$dragger.css("width",width+"px").css("height",height+"px").css("top",e.top+"px").css("left",e.left+"px"),$userimage.css("background-size",width+"px "+height+"px").css("background-position",e.left+"px "+e.top+"px")})}}),$("body").delegate("input[name=template]","change",function(){var e=$(this).val(),a="images/object/"+e+".png";$coverimage.css("background-image","url("+a+")"),1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner"),$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){[this.width,this.height],[$userimage.width(),$userimage.height()]})}),$("#normalSubmit").click(function(){var e=($userimage.width(),getBackgroundSize($userimage.css("background-size")),getBackgroundPosition($userimage.css("background-position")),$("input[name=template]:checked").val()),a=$("#source").val();3*$dragger.width(),3*$dragger.height(),3*$dragger.position().left,3*$dragger.position().top;createImage(e,a,3)})}),$(window).konami({code:[55,55,55],cheat:function(){$(".banana").slideDown()}}),$(window).konami({code:[54,54,54],cheat:function(){$("h1,#size-slider").delay(100).animate({opacity:"0"},2900),$("#formbuttons,.template-label").delay(400).animate({opacity:"0"},2600),$("#settings").delay(1e3).animate({opacity:"0"},2e3),$(".left-bottom-corner").delay(800).animate({opacity:"0"},2200),$(".preview").animate({top:"-500px",opacity:"0.5"},3e3).animate({width:"0",opacity:"0"},3e3,function(){$("#content").slideUp()})}}),$(function(){var e=document.getElementById("drop");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),$(".uploadBtn").click(function(){$("#uploadInput").click()}),$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput"),loadImage(input.files),container_size=[$userimage.width(),$userimage.height()],userimage_size=getImgSize(getBackgroundImage($userimage))})});